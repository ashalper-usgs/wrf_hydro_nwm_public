CPP = @CPP@
CC = @CC@
CFLAGS = @CFLAGS@

FC = @FC@
FCFLAGS = @FCFLAGS@
# TODO: try to replace with some permutation of
# https://www.gnu.org/software/autoconf-archive/ax_lib_netcdf4.html
NETCDF4_FFLAGS = -I/cxfs/projects/root/opt/netcdf/netcdf-4.4.1_intel/include

LDFLAGS = @LDFLAGS@

cmodules = \
	cio \
	io_f \
	decode_jpeg2000 \
	swap4c

fmodules = \
	module_grib2_tables \
	trig_degrees \
	module_input_data_structure \
	arguments_module \
	gbytesys \
	swap4f \
	module_llxy \
	kwm_date_utilities \
	kwm_grid_utilities \
	kwm_timing_utilities \
	kwm_string_utilities \
	get_unused_unit \
	module_mapinfo \
	module_grib \
	module_grib_common

f90modules = $(fmodules) module_grib1 module_grib2 module_geo_em

objects = $(addsuffix .o, $(cmodules) $(f90modules))

lib = libsmda.a

all: $(lib)

$(lib): $(objects) module_grib2.o module_geo_em.o
	ar q $@ $(objects)

$(addsuffix .o, $(cmodules)): %.o: %.c
	$(CC) $(CFLAGS) -o $@ -c $<

$(addsuffix .o, $(fmodules)): %.o: %.f90
	$(FC) $(FCFLAGS) -o $@ -c $<

module_geo_em.o: %.o: %.f90
	$(FC) $(FCFLAGS) $(NETCDF4_FFLAGS) -o $@ -c $<

$(addsuffix .f90, $(f90modules)): %.f90: %.F
	$(CPP) $(CPPFLAGS) $< > $@

module_grib2.o:	module_grib2.f90 module_grib2_tables.o module_grib1.o module_mapinfo.o kwm_date_utilities.o module_grib_common.o
	$(FC) $(FCFLAGS) $(NETCDF4_FFLAGS) -ffree-line-length-none -o $@ -c $<

module_grib1.o: module_grib1.f90 module_mapinfo.o kwm_date_utilities.o module_grib_common.o
	$(FC) $(FCFLAGS) -ffree-line-length-none -o $@ -c $<

module_grib.o: module_grib.F module_grib1.o module_grib2.o

module_input_data_structure.o: module_llxy.o

clean:
	rm -f $(objects) $(lib) *.mod *.f90 *.s *~
