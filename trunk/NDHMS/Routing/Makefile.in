# Makefile.in

include ../global.mk

CPP = @CPP@
CPPFLAGS = @CPPFLAGS@
DEFS = @DEFS@

MPIFC = @MPIFC@
FCFLAGS = @FCFLAGS@

objects = $(addsuffix .o, module_date_utilities_rt Noah_distr_routing	\
            module_UDMAP module_GW_baseflow module_HYDRO_utils		\
            module_NWM_io_dict module_HYDRO_io module_NWM_io		\
            module_noah_chan_param_init_rt module_RT			\
            module_channel_routing module_gw_gw2d module_lsm_forcing)

all: $(objects)

module_date_utilities_rt.o: %.o: %.f
	$(MPIFC) -o $@ $(FCFLAGS) $<

module_lsm_forcing.o module_noah_chan_param_init_rt.o: %.o: %.f
	$(MPIFC) -o $@ $(FCFLAGS) -I../MPP $<

Noah_distr_routing.o: %.o: %.f module_RT.o ../MPP/mpp_land.o \
                      ../Data_Rec/module_RT_data.o
	$(MPIFC) -o $@ $(FCFLAGS) -IOverland -I../MPP -I../Data_Rec $<

module_gw_gw2d.o: %.o: %.f module_HYDRO_io.o ../MPP/mpp_land.o	\
                  ../Data_Rec/module_gw_gw2d_data.o
	$(MPIFC) -o $@ $(FCFLAGS) $(addprefix -I,$(dir $^)) $<

ifneq ($(WRF_HYDRO_NUDGING),1)
module_HYDRO_io.o: %.o: %.f module_HYDRO_utils.o ../MPP/mpp_land.o \
                   ../Data_Rec/module_namelist.o
	$(MPIFC) -o $@ $(FCFLAGS) -I../MPP -I../Data_Rec $<
else
# TODO: this needs prerequisites and -I options
module_HYDRO_io.o: %.o: %.f
	$(MPIFC) -o $@ $(FCFLAGS) $<
endif

module_NWM_io_dict.o: module_NWM_io_dict.f ../MPP/mpp_land.o ../Data_Rec/module_namelist.o
	$(MPIFC) -o $@ $(FCFLAGS) -I../MPP -I../Data_Rec $<

module_NWM_io.o: %.o: %.f ../MPP/mpp_land.o ../Data_Rec/module_RT_data.o
	$(MPIFC) -o $@ $(FCFLAGS) -I../MPP -I../Data_Rec $<

module_HYDRO_utils.o: module_HYDRO_utils.f ../MPP/mpp_land.o ../Data_Rec/module_RT_data.o
	$(MPIFC) -o $@ $(FCFLAGS) -I../MPP -I../Data_Rec $<

ifneq ($(WRF_HYDRO_NUDGING),1)
module_RT.o: %.o: %.f module_GW_baseflow.o module_HYDRO_io.o		\
             module_HYDRO_utils.o module_noah_chan_param_init_rt.o	\
             ../MPP/module_mpp_ReachLS.o ../Data_Rec/module_RT_data.o
	$(MPIFC) -o $@ $(FCFLAGS) -I../MPP -I../Data_Rec $<
else
# TODO: this needs prerequisites and -I options
module_RT.o: %.o: %.f
	$(MPIFC) -o $@ $(FCFLAGS) $<
endif

module_GW_baseflow.o: module_GW_baseflow.f module_UDMAP.o ../MPP/mpp_land.o
	$(MPIFC) -o $@ $(FCFLAGS) -I../MPP $<

module_UDMAP.o: module_UDMAP.f $(addprefix ../Data_Rec/,module_namelist.o module_RT_data.o)
	$(MPIFC) -o $@ $(FCFLAGS) -I../Data_Rec -I../MPP $<

ifneq ($(WRF_HYDRO_NUDGING),1)
module_channel_routing.o: %.o: %.f ../MPP/mpp_land.o ../Data_Rec/module_RT_data.o
	$(MPIFC) -o $@ $(FCFLAGS) -I../MPP -I../Data_Rec $<
else
module_channel_routing.o: module_UDMAP.o $(addprefix ../nudging/,	\
                          module_date_utils_nudging.o			\
                          module_nudging_utils.o			\
                          module_stream_nudging.o)
	$(MPIFC) -o $@ $(FCFLAGS) $<
endif

%.f: %.F
	$(CPP) $(CPPFLAGS) $(DEFS) $< > $@

module_gw_gw2d.f: %.f: %.F
	$(CPP) $(CPPFLAGS) $(DEFS) -I../Data_Rec $< > $@

clean:	
	cd Overland && make $@
	rm -f *.o *.mod *.stb *~ *.f
