# Makefile.in

.PHONY: all Overland clean

DEFS = @DEFS@

include ../global.mk

CPP = @CPP@
CPPFLAGS = $(strip @CPPFLAGS@)

MPIFC = @MPIFC@
FCFLAGS = $(strip @FCFLAGS@)
NETCDF4_FFLAGS = @NETCDF4_FFLAGS@

objects = $(addsuffix .o, module_date_utilities_rt Noah_distr_routing	\
            module_UDMAP module_GW_baseflow module_HYDRO_utils		\
            module_NWM_io_dict module_HYDRO_io module_NWM_io		\
            module_noah_chan_param_init_rt module_RT			\
            module_channel_routing module_gw_gw2d module_lsm_forcing)

all: Overland $(objects)

Overland:
	cd $@ && make

module_date_utilities_rt.o: %.o: %.f
	$(MPIFC) -o $@ $(FCFLAGS) $<

module_noah_chan_param_init_rt.o: %.o: %.f ../MPP/mpp_land.o
	$(MPIFC) -o $@ $(FCFLAGS) $(addprefix -I,$(^D)) $<

module_lsm_forcing.o: %.o: %.f ../MPP/mpp_land.o
	$(MPIFC) -o $@ $(FCFLAGS) $(NETCDF4_FFLAGS) \
                 $(addprefix -I,$(^D)) $<

Noah_distr_routing.o: %.o: %.f module_RT.o Overland/module_overland.o	\
                      ../MPP/mpp_land.o ../Data_Rec/module_RT_data.o
	$(MPIFC) -o $@ $(FCFLAGS) $(addprefix -I,$(^D)) $<

module_gw_gw2d.o: %.o: %.f Overland/module_overland.o	\
                  module_HYDRO_io.o ../MPP/mpp_land.o	\
                  ../Data_Rec/module_gw_gw2d_data.o
	$(MPIFC) -o $@ $(FCFLAGS) $(NETCDF4_FFLAGS) $(addprefix -I,$(^D)) $<

ifneq ($(WRF_HYDRO_NUDGING),1)
module_HYDRO_io.o: %.o: %.f module_HYDRO_utils.o		\
                   Overland/module_overland.o ../MPP/mpp_land.o	\
                   ../Data_Rec/module_namelist.o
	$(MPIFC) -o $@ $(FCFLAGS) $(NETCDF4_FFLAGS) \
                 $(addprefix -I,$(^D)) $<
else
module_HYDRO_io.o: %.o: %.f module_HYDRO_utils.o ../MPP/mpp_land.o \
                   ../Data_Rec/module_namelist.o
	$(MPIFC) -o $@ $(FCFLAGS) $(addprefix -I,$(^D)) $<
endif

module_NWM_io_dict.o: %.o: %.f ../MPP/mpp_land.o	\
                      ../Data_Rec/module_namelist.o
	$(MPIFC) -o $@ $(FCFLAGS) $(NETCDF4_FFLAGS) \
                 $(addprefix -I,$(^D)) $<

module_NWM_io.o: %.o: %.f Overland/module_overland.o ../MPP/mpp_land.o \
                 ../Data_Rec/module_RT_data.o
	$(MPIFC) -o $@ $(FCFLAGS) $(NETCDF4_FFLAGS) \
                 $(addprefix -I,$(^D)) $<

module_HYDRO_utils.o: %.o: %.f Overland/module_overland.o \
                      ../MPP/mpp_land.o ../Data_Rec/module_RT_data.o
	$(MPIFC) -o $@ $(FCFLAGS) $(addprefix -I,$(^D)) $<

ifneq ($(WRF_HYDRO_NUDGING),1)
module_RT.o: %.o: %.f module_GW_baseflow.o module_HYDRO_io.o		\
             module_HYDRO_utils.o module_noah_chan_param_init_rt.o	\
             Overland/module_overland.o ../MPP/module_mpp_ReachLS.o	\
             ../Data_Rec/module_RT_data.o
	$(MPIFC) -o $@ $(FCFLAGS) $(NETCDF4_FFLAGS) \
                 $(addprefix -I,$(sort $(^D))) $<
else
module_RT.o: %.o: %.f module_GW_baseflow.o module_HYDRO_io.o	\
             module_noah_chan_param_init_rt.o ../MPP/mpp_land.o	\
             ../Data_Rec/module_RT_data.o
	$(MPIFC) -o $@ $(FCFLAGS) $(addprefix -I,$(sort $(^D))) $<
endif

module_GW_baseflow.o: module_GW_baseflow.f module_UDMAP.o ../MPP/mpp_land.o
	$(MPIFC) -o $@ $(FCFLAGS) $(addprefix -I,$(^D)) $<

module_UDMAP.o: %.o: %.f ../MPP/mpp_land.o \
                $(addprefix ../Data_Rec/,module_namelist.o module_RT_data.o)
	$(MPIFC) -o $@ $(FCFLAGS) $(addprefix -I,$(sort $(^D))) $<

ifneq ($(WRF_HYDRO_NUDGING),1)
module_channel_routing.o: %.o: %.f Overland/module_overland.o \
                          ../MPP/mpp_land.o ../Data_Rec/module_RT_data.o
	$(MPIFC) -o $@ $(FCFLAGS) $(addprefix -I,$(^D)) $<
else
module_channel_routing.o: %.o: %.f module_UDMAP.o ../MPP/mpp_land.o	\
                          ../Data_Rec/module_RT_data.o $(addprefix	\
                          ../nudging/, module_date_utils_nudging.o	\
                          module_nudging_utils.o			\
                          module_stream_nudging.o)
	$(MPIFC) -o $@ $(FCFLAGS) $(addprefix -I,$(^D)) $<
endif

%.f: %.F
	$(CPP) $(CPPFLAGS) $(DEFS) $< > $@

module_gw_gw2d.f: %.f: %.F ../Data_Rec/gw_field_include.inc
	$(CPP) $(CPPFLAGS) $(DEFS) $(addprefix -I,$(^D)) $< > $@

module_UDMAP.f module_HYDRO_io.f module_HYDRO_utils.f module_lsm_forcing.f: %.f: %.F
	$(CPP) $(CPPFLAGS) $(DEFS) $(NETCDF4_FFLAGS) $< > $@

clean:	
	cd Overland && make $@
	rm -f *.o *.mod *.s *.stb *~ *.f
