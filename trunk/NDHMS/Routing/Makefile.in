# Makefile.in

.SUFFIXES:
.SUFFIXES: .o .F

# TODO: replace RH side of assignments below with Autoconf macro
# substitutions.

# This is a WRF environment variable. Always set to 1 = On for
# compiling WRF-Hydro.
WRF_HYDRO = 1

# Enhanced diagnostic output for debugging: 0 = Off, 1 = On.
HYDRO_D = 1

# Spatially distributed parameters for NoahMP: 0 = Off, 1 = On.
SPATIAL_SOIL = 0  

# RAPID model: 0 = Off, 1 = On.
WRF_HYDRO_RAPID = 0

# Large netcdf file support: 0 = Off, 1 = On.
WRFIO_NCD_LARGE_FILE_SUPPORT = 1

# WCOSS file units: 0 = Off, 1 = On. 
NCEP_WCOSS = 0

# Streamflow nudging: 0 = Off, 1 = On.
WRF_HYDRO_NUDGING = 0

ifeq ($(SPATIAL_SOIL),1)
SPATIAL_SOIL = -DSPATIAL_SOIL
else
SPATIAL_SOIL = 
endif

ifeq ($(HYDRO_REALTIME),1)
HYDRO_REALTIME = -DHYDRO_REALTIME
else
HYDRO_REALTIME =
endif

ifeq ($(WRF_HYDRO),1)
WRF_HYDRO = -DWRF_HYDRO $(HYDRO_REALTIME)
else
WRF_HYDRO =
endif

ifeq ($(WRF_HYDRO_RAPID),1)
WRF_HYDRO = -DWRF_HYDRO -DWRF_HYDRO_RAPID $(HYDRO_REALTIME)
endif

ifeq ($(HYDRO_D),1)
HYDRO_D = -DHYDRO_D $(WRF_HYDRO)
else
HYDRO_D = $(WRF_HYDRO)
endif

ifeq ($(WRFIO_NCD_LARGE_FILE_SUPPORT),1)
WRFIO_NCD_LARGE_FILE_SUPPORT = -DWRFIO_NCD_LARGE_FILE_SUPPORT
else
WRFIO_NCD_LARGE_FILE_SUPPORT =
endif

ifeq ($(WRF_HYDRO_NUDGING),1)
WRF_HYDRO_NUDGING = -DWRF_HYDRO_NUDGING
else
WRF_HYDRO_NUDGING = 
endif

ifeq ($(OUTPUT_CHAN_CONN),1)
OUTPUT_CHAN_CONN = -DOUTPUT_CHAN_CONN
else
OUTPUT_CHAN_CONN = 
endif

ifeq ($(PRECIP_DOUBLE),1)
PRECIP_DOUBLE = -DPRECIP_DOUBLE
else
PRECIP_DOUBLE = 
endif

COMPILER90 = mpif90
F90FLAGS = -w -c -ffree-form -ffree-line-length-none -fconvert=big-endian -frecord-marker=4
MODFLAG	= -I../Data_Rec -I../MPP
LDFLAGS	=	
CPP = cpp
CPPFLAGS = -P -xassembler-with-cpp -traditional -DMPP_LAND -I../Data_Rec $(HYDRO_D) $(SPATIAL_SOIL) $(WRFIO_NCD_LARGE_FILE_SUPPORT)  $(WRF_HYDRO_NUDGING) $(OUTPUT_CHAN_CONN) $(PRECIP_DOUBLE)

LIBS 	=	
NETCDFINC       =       $(NETCDF_INC)
NETCDFLIB       =       -L$(NETCDF_LIB) -lnetcdff -lnetcdf
NETCDF_INC = /usr/include
NETCDF_LIB = netcdf
NETCDFLIB = -Lnetcdff -lnetcdff

OBJS = \
	module_date_utilities_rt.o \
	module_UDMAP.o \
	module_HYDRO_utils.o \
	module_noah_chan_param_init_rt.o \
	module_GW_baseflow.o \
	module_gw_gw2d.o \
	module_HYDRO_io.o \
	module_RT.o \
	Noah_distr_routing.o \
	module_channel_routing.o \
	module_lsm_forcing.o \
	module_date_utilities_rt.o \
	module_NWM_io_dict.o \
	module_NWM_io.o

all:	$(OBJS)

.F.o:
	$(CPP) $(CPPFLAGS) -I$(NETCDFINC) $(*).F > $(*).f
	$(COMPILER90) -o $(@) $(F90FLAGS) $(LDFLAGS) $(MODFLAG) -I$(NETCDFINC) $(*).f
# TODO:	ar -r ../lib/libHYDRO.a $(@)
# TODO:	cp *.mod ../mod

module_gw_gw2d.o: ../Data_Rec/module_gw_gw2d_data.o module_HYDRO_io.o

ifneq ($(WRF_HYDRO_NUDGING),-DWRF_HYDRO_NUDGING)
module_HYDRO_io.o:  module_HYDRO_utils.o \
	            module_date_utilities_rt.o \
                    ../Data_Rec/module_namelist.o \
	 	    ../Data_Rec/module_RT_data.o 
else 
module_HYDRO_io.o:  module_HYDRO_utils.o \
	            module_date_utilities_rt.o \
		    ../nudging/module_date_utils_nudging.o \
	            ../nudging/module_nudging_io.o \
                    ../Data_Rec/module_namelist.o \
	 	    ../Data_Rec/module_RT_data.o 
endif

module_NWM_io_dict: ../Data_Rec/module_namelist.o

module_NWM_io: module_HYDRO_utils.o \
               module_NWM_io_dict.o \
               module_HYDRO_io.o \
               module_date_utilities_rt.o \
               ../Data_Rec/module_namelist.o \
               ../Data_Rec/module_RT_data.o

module_HYDRO_utils.o: ../Data_Rec/module_namelist.o ../Data_Rec/module_RT_data.o

module_lsm_forcing.o: module_HYDRO_io.o 

ifneq ($(WRF_HYDRO_NUDGING),-DWRF_HYDRO_NUDGING)
module_RT.o: module_GW_baseflow.o \
	     module_HYDRO_utils.o \
             module_HYDRO_io.o \
             module_noah_chan_param_init_rt.o \
	     module_UDMAP.o \
	     ../Data_Rec/module_namelist.o \
	     ../Data_Rec/module_RT_data.o \
	     ../Data_Rec/module_gw_gw2d_data.o
else
module_RT.o: module_GW_baseflow.o \
	     module_HYDRO_utils.o \
             module_HYDRO_io.o \
             module_noah_chan_param_init_rt.o \
	     module_UDMAP.o \
	     ../Data_Rec/module_namelist.o \
	     ../Data_Rec/module_RT_data.o \
	     ../Data_Rec/module_gw_gw2d_data.o \
             ../nudging/module_date_utils_nudging.o \
             ../nudging/module_nudging_io.o
endif

module_UDMAP.o: ../Data_Rec/module_namelist.o ../Data_Rec/module_RT_data.o

ifneq ($(WRF_HYDRO_NUDGING),-DWRF_HYDRO_NUDGING)
module_channel_routing.o: module_UDMAP.o
else
module_channel_routing.o: module_UDMAP.o\
			  ../nudging/module_date_utils_nudging.o \
		          ../nudging/module_nudging_utils.o \
		  ../nudging/module_stream_nudging.o
endif

clean:	
	rm -f *.o *.mod *.stb *~ *.f
