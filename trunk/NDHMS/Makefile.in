# Makefile.in

.PHONY: all BASIC clean

DEFS = @DEFS@

include global.mk

objects = \
  $(addsuffix /*.o,MPP Routing Routing/Overland Data_Rec HYDRO_drv LandModel_cpl) \
  $(addsuffix /*.o,$(addprefix LandModel/,Utility_routines phys IO_code))

all: Land_models/NoahMP/run/hrldas.exe

Land_models/NoahMP/run/hrldas.exe: libHYDRO.a
	cd $(dir $@) && make

# TODO: still need to get dependencies sorted out here. The commands
# below are sequence-sensitive.
libHYDRO.a:
	cd MPP && make
	cd Routing/Overland && make clean && make # <- hack; try to fix
	cd Data_Rec && make
	cd Routing && make
	cd HYDRO_drv && make
	if [ $(WRF_HYDRO_RAPID) = 1 ]; then \
	   (cd Rapid_routing && make -f makefile.cpl rapid); \
	fi
        ifneq ($(WRF_HYDRO_RAPID),1)
	  ar -r $@ $(objects)
        else
	  ar -r $@ $(objects) Rapid_routing/.o
        endif

install:
	if [ ! -d "Run" ]; then \
	   (mkdir Run); \
	fi
	cp Land_models/NoahMP/run/hrldas.exe Run/wrf_hydro.exe

clean:
	for dir in MPP Data_Rec Routing HYDRO_drv; do \
	  (cd $$dir && make clean); \
	done
	if [ $(WRF_HYDRO_RAPID) = 1 ]; then \
	   rm -f lib/librapid.a; \
	   (cd Rapid_routing && make -f makefile.cpl clean); \
	fi
	cd MPP && make clean
	rm -rf libHYDRO.a Run *~ lib/*.a
